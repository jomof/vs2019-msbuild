<!--
***********************************************************************************************
Microsoft.Cpp.Redirect.14.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

This file is used to build Visual C++ projects with the VS2010 toolset.

Copyright (C) Microsoft Corporation. All rights reserved.
***********************************************************************************************
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- An empty target in case some old toolsets did not import vc common targets -->
  <Target Name="_PrepareForReferenceResolution" />

  <PropertyGroup>
    <!-- targets which define WinMDAssembly and/or ManagedAssembly properties -->
    <DetermineProjectTypeTargets>_PrepareForReferenceResolution;$(DetermineProjectTypeTargets)</DetermineProjectTypeTargets>
  </PropertyGroup>

  <Import Condition="'$(_ToolsetVCTargetsVersion)' == 'v140'" Project="$(VCTargetsPath)\Microsoft.Cpp.ToolsetLocation.targets"/>
  <Import Condition="'$(_ToolsetVCTargetsVersion)' != 'v140'" Project="$(VCTargetsPath)\Microsoft.Cpp.Redirect.12.targets"/>
  
  <!-- targets modification required for Dev15 from Dev14 -->

  <PropertyGroup>
    <RequiredBundles />
  </PropertyGroup>
  
  <!-- overriding CustomBuildStep so it produces correct tlogs required by Dev15 and later up-to-date check -->
  <Target Name="CustomBuildStep"
          Condition="'@(CustomBuildStep)' != '' and '$(SelectedFiles)'==''"
          Inputs="%(CustomBuildStep.Inputs);$(ProjectFileName)"
          Outputs="%(CustomBuildStep.Outputs)"
          DependsOnTargets="ComputeCustomBuildOutput"
          BeforeTargets="$(CustomBuildBeforeTargets)"
          AfterTargets="$(CustomBuildAfterTargets)"
          >
    <Message Text="%(CustomBuildStep.Message)" Condition="%(CustomBuildStep.Message) != ''" Importance="High" />

    <!-- write tlogs to track custom build step inputs and outputs -->
    <ItemGroup>
      <_CustomBuildStepInput Include="@(CustomBuildStep->MetaData('Inputs')->FullPath()->ToUpperInvariant()->Distinct())" />
    </ItemGroup>
    <ItemGroup>
      <_CustomBuildStepInputForOutput Include="@(_CustomBuildStepInput, '|')" />
    </ItemGroup>

    <WriteLinesToFile File="$(TLogLocation)CustomBuildStep.read.1u.tlog"
                      Lines="@(_CustomBuildStepInput->'^%(Identity)');"
                      Encoding="Unicode"
                      Overwrite="true"/>
    <WriteLinesToFile File="$(TLogLocation)CustomBuildStep.write.1u.tlog"
                      Lines="@(_CustomBuildStepInputForOutput->'^%(Identity)');@(CustomBuildStep->MetaData('Outputs')->FullPath()->ToUpperInvariant()->Distinct())"
                      Encoding="Unicode"
                      Overwrite="true"/>

    <Exec Command="%(CustomBuildStep.Command)$(_BuildSuffix)" />

    <ItemGroup>
      <_CustomBuildStepInput Remove="@(_CustomBuildStepInput)" />
      <_CustomBuildStepInputForOutput Remove="@(_CustomBuildStepInputForOutput)" />
    </ItemGroup>
  </Target>
</Project>
